<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <!-- Include the CesiumJS JavaScript and CSS files -->
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.119/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.119/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
</head>

<style>
  .app .data .map {
    position: relative;
  }

  html,
  body,
  #cesiumContainer,
  .leaflet-container {
    position: absolute;
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
  }
</style>

<body>
  <div id="cesiumContainer"></div>
  <script>
    const sessions = [
      {
        "_id": "66549f4ea9a89c15259500e1",
        "filename": "/var/recorder/AudioFiles/05-2024/12573_999000000000110522_999000000000110522_27-05-2024_14-57-14.bin",
        "organization_id": 12573,
        "duration": 84800,
        "receiver_id": {
          "low": 43986874,
          "high": 232597813,
          "unsigned": false
        },
        "sender_id": {
          "low": 43966435,
          "high": 232597813,
          "unsigned": false
        },
        "session_id": {
          "low": 43986874,
          "high": 232597813,
          "unsigned": false
        },
        "session_priority": "Low",
        "session_type": 2,
        "time_start": 1716821838015,
        "time_end": 1716824334025,
        "bursts": [
          {
            "sender_id": {
              "low": 43966435,
              "high": 232597813,
              "unsigned": false
            },
            "sequence_id": "0.129.000.1",
            "talker_name": "Nissim2",
            "talker_priority": 0,
            "time_start": 1716823822318,
            "time_end": 1716823828018,
            "is_enc": false,
            "duration": "00:05:700",
            "time_start_formatted": "27/05/2024 18:30:22"
          },
          {
            "sender_id": {
              "low": 43966435,
              "high": 232597813,
              "unsigned": false
            },
            "sequence_id": "0.131.000.1",
            "talker_name": "Nissim2",
            "talker_priority": 0,
            "time_start": 1716823924447,
            "time_end": 1716823927747,
            "is_enc": false,
            "duration": "00:03:300",
            "time_start_formatted": "27/05/2024 18:32:04"
          },
          {
            "sender_id": {
              "low": 43966435,
              "high": 232597813,
              "unsigned": false
            },
            "sequence_id": "0.133.000.1",
            "talker_name": "Nissim2",
            "talker_priority": 0,
            "time_start": 1716824007633,
            "time_end": 1716824013933,
            "is_enc": false,
            "duration": "00:06:300",
            "time_start_formatted": "27/05/2024 18:33:27"
          },
          {
            "sender_id": {
              "low": 43966435,
              "high": 232597813,
              "unsigned": false
            },
            "sequence_id": "0.135.000.1",
            "talker_name": "Nissim2",
            "talker_priority": 0,
            "time_start": 1716824029036,
            "time_end": 1716824038036,
            "is_enc": false,
            "duration": "00:09:00",
            "time_start_formatted": "27/05/2024 18:33:49"
          },
          {
            "sender_id": {
              "low": 43966435,
              "high": 232597813,
              "unsigned": false
            },
            "sequence_id": "0.137.000.1",
            "talker_name": "Nissim2",
            "talker_priority": 0,
            "time_start": 1716824070163,
            "time_end": 1716824074363,
            "is_enc": false,
            "duration": "00:04:200",
            "time_start_formatted": "27/05/2024 18:34:30"
          },
          {
            "sender_id": {
              "low": 43966435,
              "high": 232597813,
              "unsigned": false
            },
            "sequence_id": "0.139.000.1",
            "talker_name": "Nissim2",
            "talker_priority": 0,
            "time_start": 1716824084868,
            "time_end": 1716824089468,
            "is_enc": false,
            "duration": "00:04:600",
            "time_start_formatted": "27/05/2024 18:34:44"
          },
          {
            "sender_id": {
              "low": 43966435,
              "high": 232597813,
              "unsigned": false
            },
            "sequence_id": "0.141.000.1",
            "talker_name": "Nissim2",
            "talker_priority": 0,
            "time_start": 1716824101893,
            "time_end": 1716824130593,
            "is_enc": false,
            "duration": "00:28:700",
            "time_start_formatted": "27/05/2024 18:35:01"
          },
          {
            "sender_id": {
              "low": 43966435,
              "high": 232597813,
              "unsigned": false
            },
            "sequence_id": "0.143.000.1",
            "talker_name": "Nissim2",
            "talker_priority": 0,
            "time_start": 1716824132402,
            "time_end": 1716824135102,
            "is_enc": false,
            "duration": "00:02:700",
            "time_start_formatted": "27/05/2024 18:35:32"
          },
          {
            "sender_id": {
              "low": 43966435,
              "high": 232597813,
              "unsigned": false
            },
            "sequence_id": "0.145.000.1",
            "talker_name": "Nissim2",
            "talker_priority": 0,
            "time_start": 1716824178327,
            "time_end": 1716824186127,
            "is_enc": false,
            "duration": "00:07:800",
            "time_start_formatted": "27/05/2024 18:36:18"
          },
          {
            "sender_id": {
              "low": 43966435,
              "high": 232597813,
              "unsigned": false
            },
            "sequence_id": "0.147.000.1",
            "talker_name": "Nissim2",
            "talker_priority": 0,
            "time_start": 1716824331325,
            "time_end": 1716824334025,
            "is_enc": false,
            "duration": "00:02:700",
            "time_start_formatted": "27/05/2024 18:38:51"
          }
        ],
        "modified_time_start": 1716823822318,
        "session_name": "amr12",
        "time_start_formatted": "27/05/2024 18:30:22",
        "session_type_name": "Radio",
        "session_type_formatted": "Radio"
      }
    ]

    function createFlashingCircle(entity) {
      return viewer.entities.add({
        position: entity.position,
        ellipse: {
          semiMinorAxis: 50, // Adjust size as needed
          semiMajorAxis: 50,
          material: new Cesium.ColorMaterialProperty(
            new Cesium.CallbackProperty(function (time, result) {
              // Flash between yellow and transparent
              return Cesium.Color.YELLOW.withAlpha(
                Math.abs(Math.sin(Date.now() / 500))
              );
            }, false)
          ),
          height: 1, // Slightly above ground
          outline: true,
          outlineColor: Cesium.Color.YELLOW
        }
      });
    }
    // Set the Cesium Ion token to `null` to avoid warnings
    Cesium.Ion.defaultAccessToken = null;

    /* Per Carto's website regarding basemap attribution: https://carto.com/help/working-with-data/attribution/#basemaps */
    let CartoAttribution = 'Map tiles by <a href="https://carto.com">Carto</a>, under CC BY 3.0. Data by <a href="https://www.openstreetmap.org/">OpenStreetMap</a>, under ODbL.'

    // Create ProviderViewModel based on different imagery sources
    // - these can be used without Cesium Ion
    var imageryViewModels = [];

    imageryViewModels.push(new Cesium.ProviderViewModel({
      name: 'OpenStreetMap',
      iconUrl: Cesium.buildModuleUrl('Widgets/Images/ImageryProviders/openStreetMap.png'),
      tooltip: 'OpenStreetMap (OSM) is a collaborative project to create a free editable \
    map of the world.\nhttp://www.openstreetmap.org',
      creationFunction: function () {
        return new Cesium.UrlTemplateImageryProvider({
          url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
          subdomains: 'abc',
          minimumLevel: 0,
          maximumLevel: 19
        });
      }
    }));
    imageryViewModels.push(new Cesium.ProviderViewModel({
      name: 'Positron',
      tooltip: 'CartoDB Positron basemap',
      iconUrl: 'http://a.basemaps.cartocdn.com/light_all/5/15/12.png',
      creationFunction: function () {
        return new Cesium.UrlTemplateImageryProvider({
          url: 'http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',
          credit: CartoAttribution,
          minimumLevel: 0,
          maximumLevel: 18
        });
      }
    }));
    imageryViewModels.push(new Cesium.ProviderViewModel({
      name: 'Positron without labels',
      tooltip: 'CartoDB Positron without labels basemap',
      iconUrl: 'http://a.basemaps.cartocdn.com/rastertiles/light_nolabels/5/15/12.png',
      creationFunction: function () {
        return new Cesium.UrlTemplateImageryProvider({
          url: 'https://{s}.basemaps.cartocdn.com/rastertiles/light_nolabels/{z}/{x}/{y}.png',
          credit: CartoAttribution,
          minimumLevel: 0,
          maximumLevel: 18
        });
      }
    }));
    imageryViewModels.push(new Cesium.ProviderViewModel({
      name: 'Dark Matter',
      tooltip: 'CartoDB Dark Matter basemap',
      iconUrl: 'http://a.basemaps.cartocdn.com/rastertiles/dark_all/5/15/12.png',
      creationFunction: function () {
        return new Cesium.UrlTemplateImageryProvider({
          url: 'https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}.png',
          credit: CartoAttribution,
          minimumLevel: 0,
          maximumLevel: 18
        });
      }
    }));
    imageryViewModels.push(new Cesium.ProviderViewModel({
      name: 'Dark Matter without labels',
      tooltip: 'CartoDB Dark Matter without labels basemap',
      iconUrl: 'http://a.basemaps.cartocdn.com/rastertiles/dark_nolabels/5/15/12.png',
      creationFunction: function () {
        return new Cesium.UrlTemplateImageryProvider({
          url: 'https://{s}.basemaps.cartocdn.com/rastertiles/dark_nolabels/{z}/{x}/{y}.png',
          credit: CartoAttribution,
          minimumLevel: 0,
          maximumLevel: 18
        });
      }
    }));
    imageryViewModels.push(new Cesium.ProviderViewModel({
      name: 'Voyager',
      tooltip: 'CartoDB Voyager basemap',
      iconUrl: 'http://a.basemaps.cartocdn.com/rastertiles/voyager_labels_under/5/15/12.png',
      creationFunction: function () {
        return new Cesium.UrlTemplateImageryProvider({
          url: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}.png',
          credit: CartoAttribution,
          minimumLevel: 0,
          maximumLevel: 18
        });
      }
    }));
    imageryViewModels.push(new Cesium.ProviderViewModel({
      name: 'Voyager without labels',
      tooltip: 'CartoDB Voyager without labels basemap',
      iconUrl: 'http://a.basemaps.cartocdn.com/rastertiles/voyager_nolabels/5/15/12.png',
      creationFunction: function () {
        return new Cesium.UrlTemplateImageryProvider({
          url: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}.png',
          credit: CartoAttribution,
          minimumLevel: 0,
          maximumLevel: 18
        });
      }
    }));
    imageryViewModels.push(new Cesium.ProviderViewModel({
      name: 'National Map Satellite',
      iconUrl: 'https://basemap.nationalmap.gov/arcgis/rest/services/USGSImageryOnly/MapServer/tile/4/6/4',
      creationFunction: function () {
        return new Cesium.UrlTemplateImageryProvider({
          url: 'https://basemap.nationalmap.gov/arcgis/rest/services/USGSImageryOnly/MapServer/tile/{z}/{y}/{x}',
          credit: 'Tile data from <a href="https://basemap.nationalmap.gov/">USGS</a>',
          minimumLevel: 0,
          maximumLevel: 16
        });
      }
    }));

    // Initialize the viewer - this works without a token!
    viewer = new Cesium.Viewer('cesiumContainer', {
      imageryProviderViewModels: imageryViewModels,
      selectedImageryProviderViewModel: imageryViewModels[1],
      animation: true,
      timeline: true,
      infoBox: false,
      homeButton: false,
      fullscreenButton: false,
      selectionIndicator: true,
    });
    // Remove the Terrain section of the baseLayerPicker
    viewer.baseLayerPicker.viewModel.terrainProviderViewModels.removeAll()
    var carIconUrl = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
      <svg fill="#000000" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
        width="800px" height="800px" viewBox="0 0 31.445 31.445"
        xml:space="preserve">
      <g>
        <g>
          <path d="M7.592,16.86c-1.77,0-3.203,1.434-3.203,3.204s1.434,3.204,3.203,3.204c1.768,0,3.203-1.434,3.203-3.204
            S9.36,16.86,7.592,16.86z M7.592,21.032c-0.532,0-0.968-0.434-0.968-0.967s0.436-0.967,0.968-0.967
            c0.531,0,0.966,0.434,0.966,0.967S8.124,21.032,7.592,21.032z"/>
          <path d="M30.915,17.439l-0.524-4.262c-0.103-0.818-0.818-1.418-1.643-1.373L27.6,11.868l-3.564-3.211
            c-0.344-0.309-0.787-0.479-1.249-0.479l-7.241-0.001c-1.625,0-3.201,0.555-4.468,1.573l-4.04,3.246l-5.433,1.358
            c-0.698,0.174-1.188,0.802-1.188,1.521v1.566C0.187,17.44,0,17.626,0,17.856v2.071c0,0.295,0.239,0.534,0.534,0.534h3.067
            c-0.013-0.133-0.04-0.26-0.04-0.396c0-2.227,1.804-4.029,4.03-4.029s4.029,1.802,4.029,4.029c0,0.137-0.028,0.264-0.041,0.396
            h8.493c-0.012-0.133-0.039-0.26-0.039-0.396c0-2.227,1.804-4.029,4.029-4.029c2.227,0,4.028,1.802,4.028,4.029
            c0,0.137-0.026,0.264-0.04,0.396h2.861c0.295,0,0.533-0.239,0.533-0.534v-1.953C31.449,17.68,31.21,17.439,30.915,17.439z
            M20.168,12.202l-10.102,0.511L12,11.158c1.051-0.845,2.357-1.305,3.706-1.305h4.462V12.202z M21.846,12.117V9.854h0.657
            c0.228,0,0.447,0.084,0.616,0.237l2.062,1.856L21.846,12.117z"/>
          <path d="M24.064,16.86c-1.77,0-3.203,1.434-3.203,3.204s1.434,3.204,3.203,3.204c1.769,0,3.203-1.434,3.203-3.204
            S25.833,16.86,24.064,16.86z M24.064,21.032c-0.533,0-0.967-0.434-0.967-0.967s0.434-0.967,0.967-0.967
            c0.531,0,0.967,0.434,0.967,0.967S24.596,21.032,24.064,21.032z"/>
        </g>
      </g>
      </svg>
`);
    viewer.dataSources
      .add(
        Cesium.GpxDataSource.load(
          "./loc-test.gpx",
          {
            clampToGround: true,
          }
        )
      )
      .then(function (dataSource) {
        var entities = dataSource.entities.values;
        for (var i = 0; i < entities.length; i++) {
          var entity = entities[i];
          if (entity.position) {
            entity.billboard = new Cesium.BillboardGraphics({
              image: carIconUrl,
              width: 50,
              height: 50,
              //verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
            });
            entity.point = undefined;

            // Add a property to store the circle entity
            entity.circleEntity = null;
          }
        }
        viewer.zoomTo(dataSource.entities);

        // Set up event listener for clock tick
        viewer.clock.onTick.addEventListener(function (clock) {
          var currentTime = Cesium.JulianDate.toDate(clock.currentTime);
          checkBurstTimes(currentTime, entities);
        });
      });

    function checkBurstTimes(currentTime, entities) {
      const currentTimestamp = currentTime.getTime();
      let anyActiveBurst = false;

      sessions.forEach(session => {
        session.bursts.forEach(burst => {
          if (currentTimestamp >= burst.time_start && currentTimestamp <= burst.time_end) {
            anyActiveBurst = true;
            entities.forEach(entity => {
              if (!entity.circleEntity) {
                entity.circleEntity = createFlashingCircle(entity);
              }
            });
          }
        });
      });

      if (!anyActiveBurst) {
        entities.forEach(entity => {
          if (entity.circleEntity) {
            viewer.entities.remove(entity.circleEntity);
            entity.circleEntity = null;
          }
        });
      }
    }

    viewer.clock.clockRange = Cesium.ClockRange.UNBOUNDED;
    viewer.clock.clockStep = Cesium.ClockStep.SYSTEM_CLOCK;

  </script>
  </div>
</body>

</html>